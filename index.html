<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Escrit√≥rio de Projetos</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --panel-radius: 22px; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .panel { background: white; border-radius: var(--panel-radius); box-shadow: 0 10px 24px rgba(0,0,0,.08); padding: 18px; }
    .panel h2 { font-weight: 700; font-size: 16px; color: #111827; margin: 8px 0 16px; }
    .grid-panels { display: grid; grid-template-columns: repeat(12, 1fr); gap: 18px; }
    .card { background: white; border-radius: var(--panel-radius); box-shadow: 0 10px 24px rgba(0,0,0,.08); padding: 18px; }
    .muted { color: #6B7280; font-size: 12px; }
    .gap-bg { background: #1f2937; }
    .chip { display:inline-block; padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; color:#374151; }
    .donut-wrap { max-width: 280px; margin: 0 auto; }
    .tab { display:flex; align-items:center; justify-content:center; padding:6px 10px; border-radius:10px; background:white; color:#374151; font-weight:600; font-size:13px; white-space:nowrap; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
    .tab.active { background:#2563eb; color:white; }
    .btn { padding:6px 12px; border-radius:10px; font-weight:600; font-size:14px; }
    .btn-sm { padding:5px 10px; border-radius:10px; font-weight:600; font-size:13px; }
    .toolbar-tabs { overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-primary:hover { background:#1d4ed8; }
    .btn-outline { background:white; border:1px solid #e5e7eb; }
    .tbl th { text-align:left; color:#4b5563; font-weight:600; }
    .tbl td { color:#111827; font-size:13px; }
.tbl th { font-size:13px; }
    .tbl tr:hover { background:#f9fafb; }
    .pill { display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#374151; }
  </style>
</head>
<body class="gap-bg min-h-screen text-gray-900">
  <div class="max-w-7xl mx-auto p-5 space-y-4">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-2 gap-3">
      <h1 class="text-white text-2xl md:text-3xl font-bold">üìä Escrit√≥rio de Projetos</h1>
      <div class="flex items-center gap-3">
        <input id="file" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
        <button id="chooseBtn" class="btn btn-primary">Enviar planilha</button>
        <button id="demoBtn" class="btn btn-outline">Usar dados de demonstra√ß√£o</button>
        <span class="chip">Padr√£o: ‚ÄúC√≥digo‚Äù, ‚ÄúNome‚Äù, ‚ÄúRespons√°vel pela a√ß√£o (Quem?)‚Äù, ‚ÄúData de in√≠cio‚Äù, ‚ÄúData de t√©rmino‚Äù, ‚ÄúDura√ß√£o (planejado)‚Äù, ‚ÄúTrabalho executado/realizado‚Äù, ‚ÄúStatus‚Äù. Extras: ‚ÄúConclu√≠da em‚Äù, ‚ÄúFase‚Äù.</span>
      </div>
    </header>

    <div id="alert" class="hidden p-3 rounded-lg bg-red-50 text-red-700 text-sm mb-3"></div>
    <!-- SCOREBOARD -->
    <section id="scoreboard" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div class="card text-center"><div class="muted">Em execu√ß√£o</div><div id="scExec" class="text-3xl font-semibold">0</div></div>
      <div class="card text-center"><div class="muted">Vencidas</div><div id="scVencidas" class="text-3xl font-semibold">0</div></div>
      <div class="card text-center"><div class="muted">Conclu√≠das no m√™s</div><div id="scConcluidasMes" class="text-3xl font-semibold">0</div></div>
      <div class="card text-center"><div class="muted">Progresso do projeto</div><div id="scProg" class="text-3xl font-semibold">0%</div></div>
    </section>


    <!-- BLOCO 1: 5 gr√°ficos executivos -->
    <section class="grid-panels">
      <div class="panel col-span-12 md:col-span-4">
        <h2>Distribui√ß√£o por Status</h2>
        <div class="donut-wrap"><canvas id="statusPie" height="120"></canvas></div>
      </div>
      <div class="panel col-span-12 md:col-span-4">
        <h2>Sa√∫de do Plano (Abertas)</h2>
        <div class="donut-wrap"><canvas id="healthPie" height="120"></canvas></div>
      </div>
      <div class="panel col-span-12 md:col-span-4">
        <h2>Throughput ‚Äì √∫ltimas 12 semanas</h2>
        <canvas id="throughput" height="160"></canvas>
      </div>
      <div class="panel col-span-12 md:col-span-8">
        <h2>Workload ‚Äî Itens Abertos por Respons√°vel (Top 10)</h2>
        <canvas id="workload" height="200"></canvas>
      </div>
      <div class="panel col-span-12 md:col-span-4">
        <h2>Distribui√ß√£o por Fase</h2>
        <canvas id="phaseBar" height="200"></canvas>
      </div>
      <div class="panel col-span-12 md:col-span-6">
        <h2>A√ß√µes Vencidas por Fase</h2>
        <div class="donut-wrap"><canvas id="overduePhasePie" height="140"></canvas></div>
      </div>
      <div class="panel col-span-12 md:col-span-6">
        <h2>A√ß√µes Conclu√≠das por Fase</h2>
        <div class="donut-wrap"><canvas id="donePhasePie" height="140"></canvas></div>
      </div>
    </section>

    <!-- BLOCO 2: Lista operacional + filtros/abas/export -->
    <section class="panel">
      <div class="flex flex-col gap-3">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
          <div id="tabs" class="toolbar-tabs flex gap-2 md:col-span-6 col-span-12">
            <button class="tab active" data-mode="overdue">Vencidas (<span id="qOverdue">0</span>)</button>
            <button class="tab" data-mode="due14">Vencem em 14 dias (<span id="qDue14">0</span>)</button>
            <button class="tab" data-mode="toplate">TOP 10 Atrasadas por Progresso</button>
          </div>
          <input id="search" type="text" placeholder="Buscar por c√≥digo, nome, respons√°vel, fase" class="md:col-span-4 col-span-12 w-full min-w-0 rounded-xl ring-1 ring-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
          <div class="flex items-center gap-2 justify-end md:col-span-2 col-span-12 min-w-0">
            <select id="phaseFilter" class="w-full max-w-xs rounded-xl ring-1 ring-gray-200 px-2 py-2 text-sm">
              <option value="">Todas as fases</option>
            </select>
            <button id="exportBtn" class="btn btn-outline btn-sm flex items-center gap-1"><span>‚¨á</span> Exportar</button>
          </div>
        </div>

        <div class="overflow-auto rounded-2xl ring-1 ring-gray-200">
          <table class="min-w-full tbl">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="codigo" onclick="setSort('codigo')">C√≥digo <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="nome" onclick="setSort('nome')">Nome <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="resp" onclick="setSort('resp')">Respons√°vel <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="fase" onclick="setSort('fase')">Fase <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="status" onclick="setSort('status')">Status <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="fim" onclick="setSort('fim')">T√©rmino <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="progresso" onclick="setSort('progresso')">Progresso <span class="sort-ind">‚Üï</span></th>
                <th class="px-4 py-3 cursor-pointer select-none" data-sort="atraso" onclick="setSort('atraso')">Atraso (pp) <span class="sort-ind">‚Üï</span></th>
              </tr>
            </thead>
            <tbody id="rows">
              <tr><td class="px-4 py-5 text-gray-500" colspan="8">Nenhum item. Dica: use ‚ÄúEnviar planilha‚Äù.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BLOCO 3: Lead time -->
    <section class="panel">
      <h2>Lead time (Conclu√≠das)</h2>
      <div id="leadStats" class="grid grid-cols-5 gap-6">
        <div><div class="muted">Amostra</div><div class="text-3xl font-semibold">0</div></div>
        <div><div class="muted">Mediana</div><div class="text-3xl font-semibold">0 d</div></div>
        <div><div class="muted">M√©dia</div><div class="text-3xl font-semibold">0 d</div></div>
        <div><div class="muted">p90</div><div class="text-3xl font-semibold">0 d</div></div>
        <div><div class="muted">p95</div><div class="text-3xl font-semibold">0 d</div></div>
      </div>
    </section>

    <section class="card">
      <div id="diag" class="text-sm"></div>
    </section>
  </div>

<script>
// ---------- Chart.js defaults ----------
Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
Chart.register(ChartDataLabels);

Chart.defaults.color = '#111827';
Chart.defaults.plugins.legend.position = 'bottom';
Chart.defaults.plugins.legend.labels.boxWidth = 14;
Chart.defaults.plugins.legend.labels.boxHeight = 14;

// ---------- Utils ----------
const byId = (id) => document.getElementById(id);
const showError = (msg) => { const a = byId('alert'); a.textContent = msg; a.classList.remove('hidden'); };
const clearError = () => byId('alert').classList.add('hidden');

const H = {
  executado: 'Trabalho executado',
  codigo: 'C√≥digo',
  nome: 'Nome',
  responsavel: 'Respons√°vel pela a√ß√£o (Quem?)',
  inicio: 'Data de in√≠cio',
  fim: 'Data de t√©rmino',
  progresso: 'Progresso',
  status: 'Status',
  concluida: 'Conclu√≠da em',
  fase: 'Fase'
};

const parsePct = (str) => {
  if (str === null || str === undefined) return NaN;
  if (typeof str === 'number') return str;
  const s = String(str).replace(/%/g,'').replace(',', '.').trim();
  const v = parseFloat(s);
  return isNaN(v) ? NaN : v;
};
const parseDate = (v) => {
  if (!v) return null;
  if (typeof v === 'number') { return XLSX.SSF ? XLSX.SSF.parse_date_code(v) : null; }
  const d = new Date(v);
  return isNaN(d) ? null : d;
};
const serialToDate = (serial) => {
  const utc_days = Math.floor(serial - 25569);
  const utc_value = utc_days * 86400; 
  const date_info = new Date(utc_value * 1000);
  const fractional_day = serial - Math.floor(serial) + 1e-10;
  let total_seconds = Math.floor(86400 * fractional_day);
  const seconds = total_seconds % 60; total_seconds = Math.floor(total_seconds / 60);
  const minutes = total_seconds % 60; const hours = Math.floor(total_seconds / 60);
  date_info.setUTCHours(hours, minutes, seconds);
  return date_info;
};
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
function daysBetween(a, b) { return (b.getTime() - a.getTime()) / (1000*60*60*24); }
function plannedPercentForDate(start, end, date) {
  if (!start || !end) return NaN;
  if (date < start) return 0;
  if (date > end) return 100;
  const total = daysBetween(start, end);
  return total <= 0 ? 100 : clamp((daysBetween(start, date) / total) * 100, 0, 100);
}
function startOfWeek(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const day = date.getUTCDay() || 7;
  if (day !== 1) date.setUTCDate(date.getUTCDate() - (day - 1));
  return date;
}
function formatBR(d){ return d.toLocaleDateString('pt-BR', { timeZone:'UTC' }); }


// -- Fase curta (ex.: "Fase 1 - ... " -> "Fase 1")
function shortPhase(v){
  const s = String(v||'').trim();
  const m = s.match(/Fase\s*(\d+)/i);
  return m ? `Fase ${m[1]}` : (s || 'Sem fase');
}

// -- Ordena√ß√£o
let SORT_KEY = null; // ex.: 'codigo','nome','resp','fase','fim','progresso','atraso'
let SORT_DIR = 'asc'; // 'asc' | 'desc'
function setSort(key){
  if (SORT_KEY === key){ SORT_DIR = (SORT_DIR === 'asc' ? 'desc' : 'asc'); }
  else { SORT_KEY = key; SORT_DIR = 'asc'; }
  updateSortIndicators();
  renderList();
}
function updateSortIndicators(){
  document.querySelectorAll('[data-sort]').forEach(el=>{
    const k = el.getAttribute('data-sort');
    el.querySelector('.sort-ind').textContent = (k===SORT_KEY ? (SORT_DIR==='asc'?'‚ñ≤':'‚ñº') : '‚Üï');
  });
}




function renderScoreboard(rows){
  const today = new Date();
  let exec=0, vencidas=0, conclMes=0;
  let totalExec = 0, totalPlan = 0;
  rows.forEach(r=>{
    const status = String(r[H.status]||'').toLowerCase();
    const isClosed = status.includes('conclu') || status.includes('cancel');
    const isExec = status.includes('exec');
    let end = r[H.fim]; end = typeof end==='number'? serialToDate(end): parseDate(end);
    let concl = r[H.concluida]; concl = typeof concl==='number'? serialToDate(concl): parseDate(concl);

    // planned work (PV)
    const dur = parseFloat(H.duracao ? r[H.duracao] : r['Dura√ß√£o']) || 0;
    if (dur > 0) totalPlan += dur;

    // executed work (EV) can be percent or absolute
    const raw = r[H.executado];
    let executed = 0;
    if (raw !== undefined && raw !== null){
      const s = String(raw).trim();
      if (s.includes('%')){ // percent value
        const pct = parsePct(s); 
        if (!isNaN(pct) && dur>0) executed = (pct/100) * dur;
      } else {
        const val = parseFloat(s.replace(',','.'));
        if (!isNaN(val)) executed = val; // absolute units (same unit as Dura√ß√£o)
      }
    }
    if (dur > 0) totalExec += Math.min(executed, dur); // cap to planned
    if (isExec) exec++;
    if (!isClosed && end && today>end){ vencidas++; }
    if (concl && concl.getMonth()===today.getMonth() && concl.getFullYear()===today.getFullYear()) conclMes++;
  });
  const prog = totalPlan>0 ? Math.round((totalExec/totalPlan)*100) : 0;

  byId('scExec').textContent = exec;
  byId('scVencidas').textContent = vencidas;
  byId('scConcluidasMes').textContent = conclMes;
  byId('scProg').textContent = prog + '%';
}

// ---------- State & derived ----------
let charts = {};
let DATA = { rows: [], derived: null };
const tol = 5;

function derive(rows){
  const today = new Date();
  const statusCounts = {};
  let openItems = 0, doneItems = 0;
  const health = { adiantada:0, atrasada:0, notrilho:0 };
  const ownersOpen = {};
  const phaseCounts = {};
  const completions = [];
  const phasesSet = new Set();

  rows.forEach(r=>{
    const status = String(r[H.status] ?? '').trim();
    const s = status.toLowerCase();
    statusCounts[status] = (statusCounts[status]||0)+1;

    const fase = shortPhase((r[H.fase] ?? 'Sem fase') || 'Sem fase');
    phasesSet.add(fase);
    phaseCounts[fase] = (phaseCounts[fase]||0)+1;

    const resp = (String(r[H.responsavel] ?? '').trim()) || '‚Äî';
    let start = r[H.inicio], end = r[H.fim];
    if (typeof start === 'number') start = serialToDate(start); else start = parseDate(start);
    if (typeof end === 'number') end = serialToDate(end); else end = parseDate(end);
    let p = parsePct(r[H.progresso]); if (isNaN(p)) p = 0;

    const isClosed = s.includes('conclu') || s.includes('cancel');
    if (isClosed) doneItems++; else openItems++;

    if (!isClosed){
      const planned = (start && end) ? plannedPercentForDate(start, end, today) : NaN;
      if (!isNaN(planned)){
        if (p - planned > tol) health.adiantada++;
        else if (planned - p > tol) health.atrasada++;
        else health.notrilho++;
      } else {
        health.notrilho++;
      }
      ownersOpen[resp] = (ownersOpen[resp]||0)+1;
    }

    let doneDate = r[H.concluida];
    if (typeof doneDate === 'number') doneDate = serialToDate(doneDate); else doneDate = parseDate(doneDate);
    if (!doneDate && isClosed){ doneDate = end || null; }
    if (doneDate) completions.push(doneDate);
  });

  const weeks = [];
  const todayWeekStart = startOfWeek(today);
  for (let i=11; i>=0; i--){
    const ws = new Date(todayWeekStart.getTime() - i*7*24*60*60*1000);
    const we = new Date(ws.getTime() + 7*24*60*60*1000);
    const count = completions.filter(d => d >= ws && d < we).length;
    weeks.push({ start: ws, count });
  }

  const top = Object.entries(ownersOpen).map(([name,count])=>({name,count})).sort((a,b)=>b.count-a.count).slice(0,10);

  return { statusCounts, health, weeks, top, phaseCounts, phases:[...phasesSet].sort(), openItems, doneItems };
}

function computeLeadTimes(rows){
  const lead = [];
  rows.forEach(r=>{
    const s = String(r[H.status] ?? '').toLowerCase();
    const closed = s.includes('conclu') || s.includes('cancel');
    if (!closed) return;
    let start = r[H.inicio];
    let end = r[H.concluida] || r[H.fim];
    if (typeof start === 'number') start = serialToDate(start); else start = parseDate(start);
    if (typeof end === 'number') end = serialToDate(end); else end = parseDate(end);
    if (!start || !end) return;
    const d = Math.max(0, Math.round(daysBetween(start, end)));
    lead.push(d);
  });
  lead.sort((a,b)=>a-b);
  const n = lead.length;
  const q = (p)=> n ? lead[Math.min(n-1, Math.max(0, Math.round((p/100)*(n-1))))] : 0;
  const mean = n ? Math.round(lead.reduce((a,b)=>a+b,0)/n) : 0;
  const med = q(50);
  return { n, mean, median: med, p90: q(90), p95: q(95) };
}

// ---------- Charts renderers ----------

function renderOverdueDonePhasePies(overdueCounts, doneCounts){
  // Overdue by Phase
  charts.overduePhase && charts.overduePhase.destroy();
  charts.overduePhase = new Chart(byId('overduePhasePie'), {
    type: 'pie',
    data: { labels: Object.keys(overdueCounts), datasets: [{ data: Object.values(overdueCounts), backgroundColor: ['#EF4444','#F59E0B','#3B82F6','#10B981','#8B5CF6','#06B6D4','#A78BFA','#84CC16','#F97316','#94A3B8'] }] },
    options: { plugins: { datalabels: { formatter: (v, ctx)=>{ const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p = Math.round((v/total)*100); return p? p+'% ('+v+')':''; }, anchor:'center', align:'center', font:{weight:'600'}, padding:2 } } }
  });
  // Done by Phase
  charts.donePhase && charts.donePhase.destroy();
  charts.donePhase = new Chart(byId('donePhasePie'), {
    type: 'pie',
    data: { labels: Object.keys(doneCounts), datasets: [{ data: Object.values(doneCounts), backgroundColor: ['#10B981','#3B82F6','#F59E0B','#EF4444','#8B5CF6','#06B6D4','#A78BFA','#84CC16','#F97316','#94A3B8'] }] },
    options: { plugins: { datalabels: { formatter: (v, ctx)=>{ const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p = Math.round((v/total)*100); return p? p+'% ('+v+')':''; }, anchor:'center', align:'center', font:{weight:'600'}, padding:2 } } }
  });
}

function renderStatusPie(ctx, statusCounts){
  charts.status && charts.status.destroy();
  charts.status = new Chart(ctx, {
    type: 'pie',
    data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#F59E0B','#EF4444','#10B981','#3B82F6','#8B5CF6'] }] },
    options: { plugins: { datalabels: { formatter: (v, ctx)=>{ const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p = Math.round((v/total)*100); return p? p+'% ('+v+')':''; }, anchor:'center', align:'center', font:{weight:'600'}, padding:2 } } }
  });
}
function renderHealthPie(ctx, health){
  charts.health && charts.health.destroy();
  charts.health = new Chart(ctx, {
    type: 'pie',
    data: { labels: ['Adiantada','Atrasada','No trilho'], datasets: [{ data: [health.adiantada, health.atrasada, health.notrilho], backgroundColor: ['#F59E0B','#3B82F6','#10B981'] }] },
    options: { plugins: { datalabels: { formatter: (v, ctx)=>{ const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0)||1; const p = Math.round((v/total)*100); return p? p+'% ('+v+')':''; }, anchor:'center', align:'center', font:{weight:'600'}, padding:2 } } }
  });
}
function renderThroughput(ctx, weeks){
  charts.throughput && charts.throughput.destroy();
  charts.throughput = new Chart(ctx, {
    type: 'line',
    data: { labels: weeks.map(w=>formatBR(w.start)), datasets: [{ data: weeks.map(w=>w.count), tension:.3, borderWidth:2, pointRadius:3, label:'Itens conclu√≠dos/semana' }] },
    options: { scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,.08)'}}, x:{ grid:{ color:'rgba(0,0,0,.06)'}}}, plugins:{ legend:{ display:false }, datalabels:{ align:'top', anchor:'end', formatter:(v)=> v||'', offset:4, font:{weight:'600'} } } }
  });
}
function renderWorkload(ctx, top){
  charts.workload && charts.workload.destroy();
  charts.workload = new Chart(ctx, {
    type: 'bar',
    data: { labels: top.map(r=>r.name), datasets:[{ data: top.map(r=>r.count), backgroundColor:'#6366F1', borderRadius:8, borderWidth:0, label:'Abertos' }] },
    options: { indexAxis:'y', scales:{ x:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,.08)' }}, y:{ grid:{ display:false } } }, plugins:{ legend:{ display:false }, datalabels:{ anchor:'end', align:'right', formatter:(v)=> v||'', offset:6, font:{weight:'600'} } } }
  });
}
function renderPhaseBar(ctx, counts){
  charts.phase && charts.phase.destroy();
  charts.phase = new Chart(ctx, {
    type: 'bar',
    data: { labels: Object.keys(counts), datasets:[{ data: Object.values(counts), backgroundColor:['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#06B6D4','#A78BFA','#84CC16','#F97316','#94A3B8'], borderRadius:6, borderWidth:0, label:'Itens' }] },
    options: { plugins:{ legend:{ display:false }, datalabels:{ anchor:'end', align:'top', formatter:(v)=> v||'', offset:4, font:{weight:'600'} } }, scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(0,0,0,.08)' }}, x:{ grid:{ display:false } } } }
  });
}

function renderDiag(info){
  byId('diag').innerHTML = `
    <div class="flex flex-wrap gap-4">
      <div><span class="chip">Abertas: <strong>${info.openItems}</strong></span></div>
      <div><span class="chip">Conclu√≠das: <strong>${info.doneItems}</strong></span></div>
    </div>`;
}

// ---------- List (abas, filtros, export) ----------
let MODE = 'overdue';
let SEARCH = '';
let PHASE = '';

function getListItems(){
  const today = new Date();
  return DATA.rows.map(r=>{
    const obj = {
      codigo: r[H.codigo],
      nome: r[H.nome],
      resp: r[H.responsavel],
      fase: shortPhase(r[H.fase] || 'Sem fase'),
      status: r[H.status],
      progresso: parsePct(r[H.progresso]),
      inicio: typeof r[H.inicio]==='number' ? serialToDate(r[H.inicio]) : parseDate(r[H.inicio]),
      fim: typeof r[H.fim]==='number' ? serialToDate(r[H.fim]) : parseDate(r[H.fim])
    };
    const planned = (obj.inicio && obj.fim) ? plannedPercentForDate(obj.inicio, obj.fim, today) : NaN;
    obj.atraso = isNaN(planned) ? 0 : Math.round(planned - (obj.progresso||0));
    const s = String(obj.status||'').toLowerCase();
    obj.isClosed = s.includes('conclu') || s.includes('cancel');
    obj.isOverdue = obj.fim && today > obj.fim && !obj.isClosed;
    obj.dueIn14 = obj.fim && !obj.isClosed && (obj.fim - today <= 14*24*60*60*1000) && (obj.fim - today >= 0);
    return obj;
  });
}
function filterList(items){
  let result = [];
  if (MODE === 'overdue') result = items.filter(x=>x.isOverdue);
  else if (MODE === 'due14') result = items.filter(x=>x.dueIn14);
  else if (MODE === 'toplate') result = items.filter(x=>!x.isClosed && x.atraso>0).sort((a,b)=>b.atraso-a.atraso).slice(0,10);
  if (PHASE) result = result.filter(x=>String(x.fase||'')===PHASE);
  if (SEARCH){
    const s = SEARCH.toLowerCase();
    result = result.filter(x =>
      String(x.codigo||'').toLowerCase().includes(s) ||
      String(x.nome||'').toLowerCase().includes(s) ||
      String(x.resp||'').toLowerCase().includes(s) ||
      String(x.fase||'').toLowerCase().includes(s)
    );
  }
  return result;
}
function renderList(){
  
  let items = filterList(getListItems());
  if (SORT_KEY){
    items = items.slice().sort((a,b)=>{
      const av = (a[SORT_KEY] ?? '');
      const bv = (b[SORT_KEY] ?? '');
      let cmp = 0;
      if (SORT_KEY === 'fim'){ // dates
        cmp = (av? av.getTime():0) - (bv? bv.getTime():0);
      } else if (SORT_KEY === 'progresso' || SORT_KEY === 'atraso'){
        cmp = (parseFloat(av)||0) - (parseFloat(bv)||0);
      } else {
        cmp = String(av).localeCompare(String(bv), 'pt-BR', { numeric:true, sensitivity:'base' });
      }
      return SORT_DIR==='asc' ? cmp : -cmp;
    });
  }

  const tbody = byId('rows');
  tbody.innerHTML = '';
  if (!items.length){
    tbody.innerHTML = `<tr><td class="px-4 py-5 text-gray-500" colspan="8">Nenhum item para os filtros atuais.</td></tr>`;
  } else {
    items.forEach(it=>{
      const end = it.fim ? new Date(it.fim) : null;
      tbody.insertAdjacentHTML('beforeend', `
        <tr class="border-t last:border-b">
          <td class="px-4 py-3">${it.codigo||'‚Äî'}</td>
          <td class="px-4 py-3">${it.nome||'‚Äî'}</td>
          <td class="px-4 py-3">${it.resp||'‚Äî'}</td>
          <td class="px-4 py-3"><span class="pill">${it.fase||'Sem fase'}</span></td>
          <td class="px-4 py-3"><span class="pill">${it.status||'‚Äî'}</span></td>
          <td class="px-4 py-3">${end ? formatBR(end) : '‚Äî'}</td>
          <td class="px-4 py-3">${isNaN(it.progresso)?'‚Äî': it.progresso + '%'}</td>
          <td class="px-4 py-3">${it.atraso>0 ? it.atraso : 0}</td>
        </tr>
      `);
    });
  }
}
function exportList(){
  
  let items = filterList(getListItems());
  if (SORT_KEY){
    items = items.slice().sort((a,b)=>{
      const av = (a[SORT_KEY] ?? '');
      const bv = (b[SORT_KEY] ?? '');
      let cmp = 0;
      if (SORT_KEY === 'fim'){ // dates
        cmp = (av? av.getTime():0) - (bv? bv.getTime():0);
      } else if (SORT_KEY === 'progresso' || SORT_KEY === 'atraso'){
        cmp = (parseFloat(av)||0) - (parseFloat(bv)||0);
      } else {
        cmp = String(av).localeCompare(String(bv), 'pt-BR', { numeric:true, sensitivity:'base' });
      }
      return SORT_DIR==='asc' ? cmp : -cmp;
    });
  }

  const header = ['C√≥digo','Nome','Respons√°vel','Fase','Status','T√©rmino','Progresso','Atraso (pp)'];
  const rows = items.map(it=>[it.codigo,it.nome,it.resp,it.fase,it.status||'', it.fim?formatBR(it.fim):'', isNaN(it.progresso)?'':(it.progresso+'%'), it.atraso]);
  const csv = [header, ...rows].map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `export_${MODE}.csv`; a.click();
  URL.revokeObjectURL(url);
}

// ---------- Wiring ----------
const tabs = Array.from(document.querySelectorAll('#tabs .tab'));
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  MODE = t.dataset.mode;
  renderList();
}));
byId('search').addEventListener('input', (e)=>{ SEARCH = e.target.value; renderList(); });
byId('phaseFilter').addEventListener('change', (e)=>{ PHASE = e.target.value; renderList(); });
byId('exportBtn').addEventListener('click', exportList);
updateSortIndicators();

// --- File input ---
const input = byId('file');
const chooseBtn = byId('chooseBtn');
chooseBtn.addEventListener('click', () => input.click());
input.addEventListener('change', (e) => handleFiles(e.target.files));

function handleFiles(files){
  clearError();
  const file = files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    const data = new Uint8Array(evt.target.result);
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    try {
      let wb;
      if (ext === 'csv') {
        const str = new TextDecoder('utf-8').decode(data);
        wb = XLSX.read(str, { type: 'string' });
      } else {
        wb = XLSX.read(data, { type: 'array' });
      }
      loadFromWorkbook(wb);
    } catch (err) {
      console.error(err);
      showError('N√£o consegui processar o arquivo (formato/estrutura). Confirme as colunas obrigat√≥rias e tente salvar como XLSX/CSV simples.');
    }
  };
  reader.readAsArrayBuffer(file);
}

// ---------- Load workbook and render ----------
function loadFromWorkbook(workbook){
  const sheetName = workbook.SheetNames[0];
  const ws = workbook.Sheets[sheetName];
  const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
  // validate headers
  const headers = Object.keys(rows[0]||{});

  // --- header alias normalization (accepts old labels) ---
  function resolveHeader(headers, aliases){
    for (const a of aliases){ if (headers.includes(a)) return a; }
    return null;
  }
  const map = {
    codigo: resolveHeader(headers, [H.codigo, 'C√≥digo']),
    nome: resolveHeader(headers, [H.nome, 'Nome', 'Nome (O qu√™?)']),
    responsavel: resolveHeader(headers, [H.responsavel, 'Respons√°vel', 'Respons√°vel pela a√ß√£o (Quem?)']),
    inicio: resolveHeader(headers, [H.inicio, 'Data de in√≠cio', 'Data de in√≠cio (Quando?)']),
    fim: resolveHeader(headers, [H.fim, 'Data de t√©rmino', 'Data de t√©rmino (Quando?)']),
    duracao: resolveHeader(headers, ['Dura√ß√£o', 'Duracao', 'Dura√ß√£o (dias)', 'Dura√ß√£o planejada', 'Trabalho planejado']),
    executado: resolveHeader(headers, [H.executado, 'Trabalho executado', 'Trabalho realizado', 'Percentual de trabalho executado', 'EV', 'Trabalho realizado (dias)', 'Horas executadas']),
    status: resolveHeader(headers, [H.status, 'Status']),
    concluida: resolveHeader(headers, [H.concluida, 'Conclu√≠da em', 'Data de conclus√£o']),
    fase: resolveHeader(headers, [H.fase, 'Fase'])
  };
  // update H with the resolved real header names
  Object.keys(map).forEach(k => { if (map[k]) H[k] = map[k]; });
  if (map.duracao) H.duracao = map.duracao;
  const required = [H.codigo,H.nome,H.responsavel,H.inicio,H.fim,(H.duracao||'Dura√ß√£o'),H.executado,H.status];
  const missing = required.filter(h => !headers.includes(h));
  if (missing.length){ return showError('Faltam colunas: ' + missing.join(', ')); }


  DATA.rows = rows;
  DATA.derived = derive(rows);

  // counters
  byId('qOverdue').textContent = countOverdue(rows);
  byId('qDue14').textContent = countDue14(rows);

  // phase options
  const sel = byId('phaseFilter');
  sel.innerHTML = '<option value="">Todas as fases</option>' + DATA.derived.phases.map(p=>`<option value="${p}">${p}</option>`).join('');

  // charts
  renderStatusPie(byId('statusPie'), DATA.derived.statusCounts);
  renderHealthPie(byId('healthPie'), DATA.derived.health);
  renderThroughput(byId('throughput'), DATA.derived.weeks);
  renderWorkload(byId('workload'), DATA.derived.top);
  renderPhaseBar(byId('phaseBar'), DATA.derived.phaseCounts);

  // new pies: overdue and done by phase
  const today = new Date();
  const overdueCounts = {};
  const doneCounts = {};
  rows.forEach(r=>{
    const phase = shortPhase(r[H.fase] || 'Sem fase');
    const status = String(r[H.status]||'').toLowerCase();
    const isClosed = status.includes('conclu') || status.includes('cancel');
    let end = r[H.fim]; end = typeof end==='number'? serialToDate(end): parseDate(end);
    if (!isClosed && end && today > end){ overdueCounts[phase] = (overdueCounts[phase]||0) + 1; }
    if (isClosed){ doneCounts[phase] = (doneCounts[phase]||0) + 1; }
  });
  renderOverdueDonePhasePies(overdueCounts, doneCounts);

  // list & stats
  renderList();
  renderLeadStats();
  renderDiag(DATA.derived);
  renderScoreboard(rows);

}

function countOverdue(rows){
  const today = new Date();
  return rows.filter(r=>{
    const s = String(r[H.status]||'').toLowerCase();
    const closed = s.includes('conclu') || s.includes('cancel');
    let end = r[H.fim]; end = typeof end==='number'? serialToDate(end): parseDate(end);
    return end && today > end && !closed;
  }).length;
}
function countDue14(rows){
  const today = new Date();
  return rows.filter(r=>{
    const s = String(r[H.status]||'').toLowerCase();
    const closed = s.includes('conclu') || s.includes('cancel');
    let end = r[H.fim]; end = typeof end==='number'? serialToDate(end): parseDate(end);
    return end && !closed && (end - today <= 14*24*60*60*1000) && (end - today >= 0);
  }).length;
}

function renderLeadStats(){
  const stats = computeLeadTimes(DATA.rows);
  const host = byId('leadStats');
  host.innerHTML = `
    <div><div class="muted">Amostra</div><div class="text-3xl font-semibold">${stats.n}</div></div>
    <div><div class="muted">Mediana</div><div class="text-3xl font-semibold">${stats.median} d</div></div>
    <div><div class="muted">M√©dia</div><div class="text-3xl font-semibold">${stats.mean} d</div></div>
    <div><div class="muted">p90</div><div class="text-3xl font-semibold">${stats.p90} d</div></div>
    <div><div class="muted">p95</div><div class="text-3xl font-semibold">${stats.p95} d</div></div>
  `;
}

// --- Demo data & self-test ---
byId('demoBtn').addEventListener('click', () => {
  const sample = [
    { [H.codigo]:'25-1001', [H.nome]:'Definir escopo do projeto', [H.responsavel]:'Joyce de Oliveira Franco', [H.inicio]:'2025-09-01', [H.fim]:'2025-09-10', [H.executado]:'80%', [H.progresso]:'88%', [H.status]:'Em execu√ß√£o', [H.fase]:'Planejamento', 'Dura√ß√£o': 10 },
    { [H.codigo]:'25-1002', [H.nome]:'Revisar riscos FMEA', [H.responsavel]:'Davi Silva', [H.inicio]:'2025-09-02', [H.fim]:'2025-09-19', [H.executado]:'60%', [H.progresso]:'75%', [H.status]:'Em execu√ß√£o', [H.fase]:'Execu√ß√£o', 'Dura√ß√£o': 18 },
    { [H.codigo]:'25-1003', [H.nome]:'Apresenta√ß√£o IATF', [H.responsavel]:'Luna R√©gia', [H.inicio]:'2025-08-28', [H.fim]:'2025-09-05', [H.executado]:'20%', [H.progresso]:'24%', [H.status]:'Em execu√ß√£o', [H.fase]:'Execu√ß√£o', 'Dura√ß√£o': 9 },
    { [H.codigo]:'25-1004', [H.nome]:'Entrega 1¬™ vers√£o', [H.responsavel]:'Equipe', [H.inicio]:'2025-08-01', [H.fim]:'2025-08-20', [H.executado]:'100%', [H.progresso]:'100%', [H.status]:'Conclu√≠da', [H.concluida]:'2025-08-19', [H.fase]:'Conclu√≠das', 'Dura√ß√£o': 20 }
  ];
  const ws = XLSX.utils.json_to_sheet(sample);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Dados');
  // carrega como se fosse um arquivo
  loadFromWorkbook(wb);

  // Pequenos testes de sanidade no console
  setTimeout(() => {
    try {
      console.assert(DATA.rows.length === sample.length, 'Deveria carregar 4 linhas');
      console.assert(document.querySelector('#rows tr') !== null, 'Tabela deve renderizar');
      console.assert(charts.status && charts.workload, 'Gr√°ficos principais prontos');
      console.log('[Teste r√°pido] OK ‚Äî layout ajustado, filtros e gr√°ficos renderizados.');
    } catch(e) { console.warn('Teste falhou:', e); }
  }, 50);
});

</script>
</body>
</html>
